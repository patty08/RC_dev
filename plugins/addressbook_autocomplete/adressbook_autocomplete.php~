<?php 

/* Adressbook Autocomplete
 *
 * Plugin that simply adds autocomplete to contact research in mails/adressbook
 * @version	: 0.1
 * @author	: Lucien Kerisit
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see http://www.gnu.org/licenses/.
*/

class adressbook_autocomplete extends rcube_plugin {

	public $task = 'mail|addressbook';
	private $rcmail;
	private $contacts;

	function init() {

		$this->rcmail = rcube::get_instance();
		$this->contacts = $this->rcmail->get_address_book($this->abook_id);

		$this->register_action('plugin.get_addressbook', array($this, 'get_suggestion'));
		
		if ($rcmail->task == 'mail' && $rcmail->action == 'compose') {
			$this->include_script('addressbook_autocomplete.js');
		}
		else if ($rcmail->task == 'addressbook' && $rcmail->action == 'list') {
			$this->include_script('addressbook_autocomplete.js');
		}

		$this->include_script('addressbook_autocomplete.js');
		
	}
	
	function get_suggestion($str = '' ) {
		$result = $this->contacts->search('email', $str, 2, true, true);
		$reponse = array();

		foreach($result->records as $r) {
			array_push($reponse, $r->name);
		}

  		$this->rcmail->output->command('plugin.callback_autocomplete', $reponse);
	}
	
}

